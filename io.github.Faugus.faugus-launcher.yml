app-id: io.github.Faugus.faugus-launcher
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '24.08'
x-gl-version: &gl-version '1.4'
x-gl-versions: &gl-versions 24.08;24.08-extra;1.4
x-gl-merge-dirs: &gl-merge-dirs vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d
command: faugus-launcher
separate-locales: false # translations
base: org.winehq.Wine
base-version: stable-24.08

finish-args:
  - --share=network
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=all
  - --allow=multiarch  # pressure-vessel
  - --socket=pulseaudio # notification sound
  - --talk-name=org.kde.StatusNotifierWatcher # system tray
  - --env=PATH=/app/bin:/app/utils/bin:/usr/bin:/usr/lib/extensions/vulkan/MangoHud/bin:/usr/lib/extensions/vulkan/gamescope/bin:/usr/lib/extensions/vulkan/OBSVkCapture/bin # mangohud, gamescope, obsvkcapture
  - --filesystem=home
  - --filesystem=xdg-data/applications:create # app launcher shortcuts
  - --filesystem=/mnt
  - --filesystem=/run/media
  - --filesystem=xdg-config/gtk-3.0:ro # system theme

inherit-extensions:
  - org.freedesktop.Platform.GL32

add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: *runtime-version
  org.freedesktop.Platform.VAAPI.Intel.i386:
    directory: lib/i386-linux-gnu/dri/intel-vaapi-driver
    version: *runtime-version
    versions: *runtime-version
    autodelete: false
    no-autodownload: true
    add-ld-path: lib
    download-if: have-intel-gpu
    autoprune-unless: have-intel-gpu

modules:
  - name: metadata
    buildsystem: simple
    build-commands:
      - install -Dm644 -t ${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
    sources:
      - type: file
        path: io.github.Faugus.faugus-launcher.metainfo.xml

  - name: bundle-setup
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib/i386-linux-gnu
      - mkdir -p /app/lib/debug/lib/i386-linux-gnu
      - mkdir -p /app/lib/i386-linux-gnu/GL
      - mkdir -p /app/lib/i386-linux-gnu/dri/intel-vaapi-driver
      - install -Dm644 ld.so.conf /app/etc/ld.so.conf
    sources:
      - type: inline
        dest-filename: ld.so.conf
        contents: |
          /app/lib32
          /app/lib/i386-linux-gnu

  - name: faugus-launcher
    buildsystem: simple
    build-commands:
      - chmod +x flatpak-patch.sh
      - ./flatpak-patch.sh
      - 'install -D faugus_launcher.py /app/bin/faugus-launcher'
      - 'install -D faugus_run.py /app/bin/faugus-run'
      - 'install -D faugus_proton_manager.py /app/bin/faugus-proton-manager'
      - 'install -D faugus_components.py /app/bin/faugus-components'
      - 'install -D umu-run /app/bin/umu-run'
      - 'install -D faugus-launcher.desktop /app/share/applications/io.github.Faugus.faugus-launcher.desktop'
      - 'install -D faugus-shortcut.desktop /app/share/applications/io.github.Faugus.faugus-launcher.shortcut.desktop'
      - 'install -D faugus-run.desktop /app/share/applications/io.github.Faugus.faugus-launcher.run.desktop'
      - 'install -D faugus-proton-manager.desktop /app/share/applications/io.github.Faugus.faugus-launcher.proton_manager.desktop'
      - 'install -D assets/faugus-launcher.png /app/share/icons/hicolor/256x256/apps/io.github.Faugus.faugus-launcher.png'
      - 'install -D assets/faugus-battlenet.png /app/share/icons/hicolor/256x256/apps/faugus-battlenet.png'
      - 'install -D assets/faugus-ea.png /app/share/icons/hicolor/256x256/apps/faugus-ea.png'
      - 'install -D assets/faugus-epic-games.png /app/share/icons/hicolor/256x256/apps/faugus-epic-games.png'
      - 'install -D assets/faugus-ubisoft-connect.png /app/share/icons/hicolor/256x256/apps/faugus-ubisoft-connect.png'
      - 'install -D assets/faugus-banner.png /app/share/faugus-launcher/faugus-banner.png'
      - 'install -D assets/faugus-notification.ogg /app/share/faugus-launcher/faugus-notification.ogg'
      - 'install -D assets/faugus-add-symbolic.svg /app/share/icons/hicolor/scalable/actions/faugus-add-symbolic.svg'
      - 'install -D assets/faugus-exit-symbolic.svg /app/share/icons/hicolor/scalable/actions/faugus-exit-symbolic.svg'
      - 'install -D assets/faugus-kill-symbolic.svg /app/share/icons/hicolor/scalable/actions/faugus-kill-symbolic.svg'
      - 'install -D assets/faugus-play-symbolic.svg /app/share/icons/hicolor/scalable/actions/faugus-play-symbolic.svg'
      - 'install -D assets/faugus-settings-symbolic.svg /app/share/icons/hicolor/scalable/actions/faugus-settings-symbolic.svg'
      - 'install -D assets/faugus-stop-symbolic.svg /app/share/icons/hicolor/scalable/actions/faugus-stop-symbolic.svg'
      - |
        mkdir -p /app/share/locale
        cd "languages" && find . -name '*.mo' -exec sh -c '
          for mo_path; do
            full_path="$(pwd)/${mo_path#./}"
            lang=$(basename $(dirname "${full_path}"))
            install -Dm644 "${full_path}" "/app/share/locale/${lang}/LC_MESSAGES/$(basename "${mo_path}")"
          done
        ' sh {} +
      - 'chmod +x /app/bin/faugus-launcher'
      - 'chmod +x /app/bin/faugus-run'
      - 'chmod +x /app/bin/faugus-proton-manager'
      - 'chmod +x /app/bin/faugus-components'
      - 'chmod +x /app/bin/umu-run'
    sources:
      - type: archive
        url: https://github.com/Faugus/faugus-launcher/archive/refs/tags/1.6.3.tar.gz
        sha256: 9ca4414db5fe9e0ff20c0bd2e07f24e376c950b201190cd8590343fa8e0aae47
      - type: file
        url: https://github.com/Faugus/components/releases/download/v1.0.0/umu-run
        sha256: 3069d5045ca356779a5ece30a54dfada0106954404d417a7d219633f533ac1ce

    modules:
      - modules/python3-pygobject.json
      - modules/python3-Pillow.json
      - modules/python3-icoextract.json
      - modules/python3-requests.json
      - modules/python3-psutil.json
      - modules/python3-vdf.json
      - modules/python3-filelock.json
      - modules/imagemagick.json
      - modules/intltool-0.51.json
      - modules/libcanberra.json
      - modules/libayatana-appindicator-gtk3.json
